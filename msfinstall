
set -x  # Enable command echoing

# Update repositories
echo "Running: sudo apt update"
sudo apt update

# Install required packages
echo "Running: sudo apt install curl wget gnupg git"
sudo apt install -y curl wget gnupg git

# Add Kali Linux repository key
echo "Running: wget -q -O - https://archive.kali.org/archive-key.asc | sudo apt-key add"
wget -q -O - https://archive.kali.org/archive-key.asc | sudo apt-key add

# Add Kali Linux repository to sources list
echo "Running: sudo sh -c \"echo 'deb https://http.kali.org/kali kali-rolling main non-free contrib' > /etc/apt/sources.list.d/kali.list\""
sudo sh -c "echo 'deb https://http.kali.org/kali kali-rolling main non-free contrib' > /etc/apt/sources.list.d/kali.list"

# Set package preferences for Kali Linux
echo "Running: sudo sh -c \"echo 'Package: *' > /etc/apt/preferences.d/kali.pref; echo 'Pin: release a=kali-rolling' >> /etc/apt/preferences.d/kali.pref; echo 'Pin-Priority: 50' >> /etc/apt/preferences.d/kali.pref\""
sudo sh -c "echo 'Package: *' > /etc/apt/preferences.d/kali.pref; echo 'Pin: release a=kali-rolling' >> /etc/apt/preferences.d/kali.pref; echo 'Pin-Priority: 50' >> /etc/apt/preferences.d/kali.pref"

# Download and install Kali Linux archive keyring
echo "Running: wget http://http.kali.org/kali/pool/main/k/kali-archive-keyring/kali-archive-keyring_2022.1_all.deb"
wget http://http.kali.org/kali/pool/main/k/kali-archive-keyring/kali-archive-keyring_2022.1_all.deb
echo "Running: sudo dpkg -i kali-archive-keyring_2022.1_all.deb"
sudo dpkg -i kali-archive-keyring_2022.1_all.deb
echo "Running: rm kali-archive-keyring_2022.1_all.deb"
rm kali-archive-keyring_2022.1_all.deb

# Update repositories again
echo "Running: sudo apt update"
sudo apt update

# Fix broken packages
echo "Running: sudo apt install -f"
sudo apt install -f

# Install Metasploit
echo "Running: sudo aptitude install -y metasploit-framework"
sudo aptitude install -y metasploit-framework